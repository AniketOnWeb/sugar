#!/usr/bin/env python
# Copyright (C) 2006-2008, Red Hat, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

import os
import random
import subprocess
import time
from optparse import OptionParser

import gtk
import gobject

from sugar import env

def _run_xephyr(display, dpi, dimensions):
    cmd = [ 'Xephyr' ]
    cmd.append(':%d' % display)
    cmd.append('-ac') 

    if dimensions is not None:
        cmd.append('-screen')
        cmd.append(dimensions)
    elif gtk.gdk.screen_width() < 1200 or gtk.gdk.screen_height() < 900:
        cmd.append('-fullscreen')
    else:
        cmd.append('-screen')
        cmd.append('%dx%d' % (1200, 900))

    if dpi is None:
        dpi = gtk.settings_get_default().get_property('gtk-xft-dpi') / 1024
    if dpi > 0:
        cmd.append('-dpi')
        cmd.append('%d' % dpi)

    result = gobject.spawn_async(cmd, flags=gobject.SPAWN_SEARCH_PATH)
    pid = result[0]

    os.environ['DISPLAY'] = ":%d" % (display)
    os.environ['SUGAR_EMULATOR_PID'] = str(pid)

def _check_xephyr(display):
    result = subprocess.call(['xdpyinfo', '-display', ':%d' % display],
                             stdout=open(os.devnull, "w"),
                             stderr=open(os.devnull, "w"))
    return result == 0

def _start_xephyr(dpi, dimensions):
    # FIXME evil workaround until F10 Xephyr is fixed
    if os.path.exists('/etc/fedora-release'):
        if open('/etc/fedora-release').read().startswith('Fedora release 10'):
            _run_xephyr(random.randint(100, 500), dpi, dimensions)
            return

    for display in range(100, 110):
        if not _check_xephyr(display):
            _run_xephyr(display, dpi, dimensions)

            tries = 10
            while tries > 0:
                if _check_xephyr(display):
                    return
                else:
                    tries -= 1
                    time.sleep(0.1)

def _start_matchbox():
    cmd = ['matchbox-window-manager']

    cmd.extend(['-use_titlebar', 'no'])
    cmd.extend(['-theme', 'sugar'])

    gobject.spawn_async(cmd, flags=gobject.SPAWN_SEARCH_PATH)

def _setup_env():
    os.environ['SUGAR_EMULATOR'] = 'yes'
    os.environ['GABBLE_LOGFILE'] = os.path.join(
            env.get_profile_path(), 'logs', 'telepathy-gabble.log')
    os.environ['SALUT_LOGFILE'] = os.path.join(
            env.get_profile_path(), 'logs', 'telepathy-salut.log')
    os.environ['STREAM_ENGINE_LOGFILE'] = os.path.join(
            env.get_profile_path(), 'logs', 'telepathy-stream-engine.log')

    path = os.path.join(os.environ.get("HOME"), '.i18n')
    if os.path.exists(path):    
        fd = open(path, "r")
        lines = fd.readlines()
        fd.close()

        language_env_variable = None
        lang_env_variable = None

        for line in lines:
            if line.startswith("LANGUAGE="):
                lang = line[9:].replace('"', '')
                language_env_variable = lang.strip()
            elif line.startswith("LANG="):
                lang_env_variable = line[5:].replace('"', '')

        # There might be cases where .i18n may not contain a LANGUAGE field
        if language_env_variable is not None:
            os.environ['LANGUAGE'] = language_env_variable
        if lang_env_variable is not None:
            os.environ['LANG'] = lang_env_variable

def main():
    """Script-level operations"""

    parser = OptionParser()
    parser.add_option('-d', '--dpi', dest='dpi', type="int",
                      help='Emulator dpi')
    parser.add_option('-s', '--scaling', dest='scaling',
                      help='Sugar scaling in %')
    parser.add_option('-i', '--dimensions', dest='dimensions',
                      help='Emulator dimensions (ex. 1200x900)')
    (options, args) = parser.parse_args()

    _setup_env()

    _start_xephyr(options.dpi, options.dimensions)

    if options.scaling:
        os.environ['SUGAR_SCALING'] = options.scaling

    command = ['dbus-launch', 'dbus-launch', '--exit-with-session']

    if not args:
        command.append('sugar')
    else:
        _start_matchbox()

        if args[0].endswith('.py'):
            command.append('python')

        command.append(args[0])
    
    os.execlp(*command)

main()
